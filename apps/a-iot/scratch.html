<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STOMP WebSocket í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #0057E3;
            margin-bottom: 10px;
        }
        .status {
            padding: 10px 15px;
            border-radius: 6px;
            margin: 20px 0;
            font-weight: 500;
        }
        .status.connected {
            background: #D1FAE5;
            color: #065F46;
        }
        .status.disconnected {
            background: #FEE2E2;
            color: #991B1B;
        }
        button {
            background: #0057E3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.2s;
        }
        button:hover:not(:disabled) {
            background: #0046B8;
            transform: translateY(-1px);
        }
        button:disabled {
            background: #D1D5DB;
            cursor: not-allowed;
        }
        button.danger {
            background: #CA0014;
        }
        button.danger:hover:not(:disabled) {
            background: #A00010;
        }
        button.warning {
            background: #F97316;
        }
        button.warning:hover:not(:disabled) {
            background: #EA580C;
        }
        button.caution {
            background: #F59E0B;
        }
        button.caution:hover:not(:disabled) {
            background: #D97706;
        }
        .button-group {
            margin: 20px 0;
        }
        #log {
            background: #1F2937;
            color: #10B981;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }
        .log-info { color: #60A5FA; }
        .log-success { color: #10B981; }
        .log-error { color: #EF4444; }
        .log-warning { color: #F59E0B; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸ”” STOMP WebSocket ì•Œë¦¼ í…ŒìŠ¤íŠ¸</h1>
        <p>ì‹¤ì‹œê°„ ì•Œë¦¼ ì‹œìŠ¤í…œì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>

        <div id="status" class="status disconnected">
            âš ï¸ ì—°ê²° ì•ˆ ë¨
        </div>

        <div class="button-group">
            <button id="connectBtn" onclick="connect()">ì—°ê²°</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>ì—°ê²° í•´ì œ</button>
        </div>

        <h3>í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡</h3>
        <div class="button-group">
            <button class="danger" onclick="sendDangerAlert()" id="dangerBtn" disabled>ğŸ”¥ DANGER ì•Œë¦¼</button>
            <button class="warning" onclick="sendWarningAlert()" id="warningBtn" disabled>âš ï¸ WARNING ì•Œë¦¼</button>
            <button class="caution" onclick="sendCautionAlert()" id="cautionBtn" disabled>âš¡ CAUTION ì•Œë¦¼</button>
        </div>

        <h3>ë¡œê·¸</h3>
        <div id="log"></div>
    </div>

    <script>
        let stompClient = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const className = `log-${type}`;
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const dangerBtn = document.getElementById('dangerBtn');
            const warningBtn = document.getElementById('warningBtn');
            const cautionBtn = document.getElementById('cautionBtn');

            if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.textContent = 'âœ… ì—°ê²°ë¨';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                dangerBtn.disabled = false;
                warningBtn.disabled = false;
                cautionBtn.disabled = false;
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.textContent = 'âš ï¸ ì—°ê²° ì•ˆ ë¨';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                dangerBtn.disabled = true;
                warningBtn.disabled = true;
                cautionBtn.disabled = true;
            }
        }

        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const brokerURL = `${protocol}//${host}/api/stomp/platform`;

            log(`ì—°ê²° ì‹œë„ ì¤‘... (${brokerURL})`, 'info');

            stompClient = new StompJs.Client({
                brokerURL: brokerURL,
                reconnectDelay: 5000,
                heartbeatIncoming: 5000,
                heartbeatOutgoing: 5000,
                debug: function (str) {
                    log(str, 'info');
                },
                onConnect: function (frame) {
                    log('âœ… STOMP ì—°ê²° ì„±ê³µ!', 'success');
                    updateStatus(true);

                    stompClient.subscribe('/queue/sensor-alarm', function (message) {
                        log('ğŸ“¨ ë©”ì‹œì§€ ìˆ˜ì‹ : ' + message.body, 'success');
                    });

                    log('âœ… /queue/sensor-alarm êµ¬ë… ì™„ë£Œ', 'success');
                },
                onDisconnect: function () {
                    log('âŒ ì—°ê²° í•´ì œë¨', 'warning');
                    updateStatus(false);
                },
                onStompError: function (frame) {
                    log('âŒ STOMP ì˜¤ë¥˜: ' + frame.headers['message'], 'error');
                    log('ìƒì„¸: ' + frame.body, 'error');
                    updateStatus(false);
                }
            });

            stompClient.activate();
        }

        function disconnect() {
            if (stompClient) {
                stompClient.deactivate();
                log('ì—°ê²° í•´ì œ ìš”ì²­ë¨', 'warning');
            }
        }

        function sendDangerAlert() {
            sendTestMessage('DANGER', 'í™”ì¬ê°ì§€', 'ğŸ”¥ í™”ì¬ ë°œìƒ');
        }

        function sendWarningAlert() {
            sendTestMessage('WARNING', 'ì˜¨ìŠµë„ê³„', 'âš ï¸ ì˜¨ë„ ê²½ê³ ');
        }

        function sendCautionAlert() {
            sendTestMessage('CAUTION', 'ë³€ìœ„ì„¼ì„œ', 'âš¡ ë³€ìœ„ ì£¼ì˜');
        }

        function sendTestMessage(level, sensorType, eventName) {
            if (!stompClient || !stompClient.connected) {
                log('âŒ STOMP ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
                return;
            }

            const testPayload = {
                deviceId: `SNIOT-P-${level.substring(0, 3)}-001`,
                eventName: eventName,
                fieldKey: sensorType === 'í™”ì¬ê°ì§€' ? 'Fire Alarm' : sensorType === 'ì˜¨ìŠµë„ê³„' ? 'Temperature' : 'Displacement',
                guideMessage: `${level} ìˆ˜ì¤€ì˜ ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤`,
                lat: 37.3948,
                level: level,
                lon: 127.1114,
                maxValue: level === 'DANGER' ? 100 : level === 'WARNING' ? 50 : 30,
                message: `í…ŒìŠ¤íŠ¸ ${level} ì•ŒëŒ`,
                minValue: level === 'DANGER' ? 90 : level === 'WARNING' ? 40 : 20,
                objectId: String(Math.floor(Math.random() * 90000) + 10000),
                profileDescription: sensorType,
                sensorDescription: sensorType,
                sensorType: sensorType === 'í™”ì¬ê°ì§€' ? 'Boolean' : 'Float',
                siteId: 1,
                siteName: 'ìœ¨ë™ê³µì›',
                status: 'PENDING',
                timestamp: new Date().toISOString(),
                unit: sensorType === 'ì˜¨ìŠµë„ê³„' ? 'Â°C' : sensorType === 'ë³€ìœ„ì„¼ì„œ' ? 'mm' : '-',
                value: level === 'DANGER' ? 95 : level === 'WARNING' ? 45 : 25
            };

            try {
                stompClient.publish({
                    destination: '/app/test/sensor-alarm',
                    body: JSON.stringify(testPayload)
                });
                log(`ğŸ“¤ ${level} ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ`, 'success');
                log(`ë°ì´í„°: ${JSON.stringify(testPayload, null, 2)}`, 'info');
            } catch (error) {
                log('âŒ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        window.addEventListener('load', function() {
            log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ. ì—°ê²° ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'info');
        });
    </script>
</body>
</html>
